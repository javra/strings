{-# OPTIONS --prop --rewriting --allow-unsolved-metas #-}

open import Diags
open import Arity
open import Identities
open import Sliding

/nsuc : ∀{n} → /n {suc n} ~ ∣ ⊗ /n · / ⊗ ∣ ^⊗ n
/nsuc {zero} = ·∣∣ ■ ε⊗ ■ - ⊗ε ■ - ∣∣·
/nsuc {suc n} = ·~ (~⊗ (/nsuc {n}) ■ - ⊗∣·⊗∣ ■ ·~ (-⊗⊗ ■ ⊗~ (- ∣^⊗suc)) ■ ~· -⊗⊗)
                ■ ~·· (~· -⊗⊗ ■ ∣⊗·∣⊗)

/n+ : ∀{m n} → /n {m + n} ~ ∣ ^⊗ m ⊗ /n {n} · /n {m} ⊗ ∣ ^⊗ n
/n+ {m} {zero} = - (~· (- ∣^⊗suc) ■ ∣n· ■ ⊗ε)
/n+ {m} {suc n} = ·~ (~⊗ (/n+ {m} {n}) ■ - ⊗∣·⊗∣ ■ ·~ (-⊗⊗ ■ ⊗~ (- ∣^⊗suc))) ■ ··
                  ■ ~· (~· (~⊗ ∣^⊗+ ■ -⊗⊗) ■ ·~ -⊗⊗ ■ ∣n⊗·∣n⊗)

/-nsuc : ∀{n} → /-n {suc n} ~ /-n ⊗ ∣ · ∣ ^⊗ _ ⊗ /
/-nsuc {zero}  = ~· ⊗ε ■ ·∣∣ ■ - ∣∣· ■ ·~ (- ε⊗)
/-nsuc {suc n} = ·~ (⊗~ /-nsuc ■ - ∣⊗·∣⊗ ■ ·~ ⊗⊗)
                 ■ ~·· (~· (⊗~ ∣^⊗suc ■ ⊗⊗) ■ ·~ ⊗⊗ ■ ⊗∣·⊗∣)

/-n+ : ∀{m n} → /-n {m + n} ~ /-n {m} ⊗ ∣ ^⊗ n · ∣ ^⊗ m ⊗ /-n {n}
/-n+ {zero}  {n} = - (∣n· ■ ε⊗)
/-n+ {suc m} {n} = ·~ (⊗~ (/-n+ {m} {n}) ■ - ∣⊗·∣⊗ ■ ·~ ⊗⊗)
                   ■ ~·· (~· (⊗~ (∣^⊗+ {m}{n}) ■ ⊗⊗) ■ ·~ ⊗⊗ ■ ⊗∣n·⊗∣n)

-- Naturality of /n
/n·∣⊗ : ∀{m n}{d : D m n} → /n · ∣ ⊗ d ~ d ⊗ ∣ · /n
/n·∣⊗ {d = ε}     = ·~ ⊗ε ■ - (~· (ε⊗))
/n·∣⊗ {d = ∣}     = ·∣∣ ■ - ∣∣·
/n·∣⊗ {d = d · e} = ·~ (- ∣⊗·∣⊗) ■ ~·· /n·∣⊗ ■ ··~ /n·∣⊗
                    ■ ~·· ⊗∣·⊗∣
/n·∣⊗ {d = _⊗_ {m} {n} {k} {l} d e}
                  = ~· (/n+ {m}{k})
                    ■ ··~ (·~ ⊗⊗ ■ - ·⊗· ■ ~⊗ /n·∣⊗ ■ ·⊗·)
                    ■ ~·· (·~ -⊗⊗ ■ ∣n⊗·⊗∣m) ■ ·~ (- ∣n⊗·⊗∣m)
                    ■ ~·· (·~ (~⊗ ∣^⊗suc ■ -⊗⊗) ■ - ·⊗· ■ ⊗~ /n·∣⊗ ■ ·⊗· ■ ~· ⊗⊗)
                    ■ ··~ (- (/n+ {n} {l}))
/n·∣⊗ {d = ∩}     = ∣· ■ - ∩∣∣//∣ ■ ··~ (~· (~⊗ (- ⊗ε)) ■ ·~ (~⊗ (- (·∣∣ ■ ε⊗))))
/n·∣⊗ {d = ∪}     = ~· (~· (~⊗ ⊗ε) ■ ·~ (~⊗ (·∣∣ ■ ε⊗))) ■ ∣//∣∣∪ ■ - ·∣
/n·∣⊗ {d = /}     = ~· (~· (~⊗ ⊗ε) ■ ·~ (~⊗ (·∣∣ ■ ε⊗))) ■ - ///
                    ■ ··~ (~· (~⊗ (- ⊗ε)) ■ ·~ (- (~⊗ (·∣∣ ■ ε⊗))))
/n·∣⊗ {d = R}     = /nR
/n·∣⊗ {d = M}     = ·~ /M ■ ∣· ■ ·~ (- ε⊗ ■ - ·∣∣)
/n·∣⊗ {d = B ns}  = /nB

-- Naturality of /-n
/-n·⊗∣ : ∀{m n}{d : D m n} → /-n · d ⊗ ∣ ~ ∣ ⊗ d · /-n
/-n·⊗∣ {d = ε}     = ∣· ■ ε⊗ ■ - ⊗ε ■ - ·∣
/-n·⊗∣ {d = ∣}     = ·∣∣ ■ - ∣∣·
/-n·⊗∣ {d = d · e} = ·~ (- ⊗∣·⊗∣) ■ ~·· /-n·⊗∣ ■ ··~ /-n·⊗∣ ■ ~·· ∣⊗·∣⊗
/-n·⊗∣ {d = _⊗_ {m}{n}{k}{l} d e} = ~· (/-n+ {m}{k})
                     ■ ··~ (·~ -⊗⊗ ■ - ·⊗· ■ ⊗~ /-n·⊗∣ ■ ·⊗·)
                     ■ ~·· (·~ (⊗⊗ ■ ~⊗ (- ∣^⊗suc)) ■ ⊗∣n·∣m⊗)
                     ■ ·~ (- ⊗∣n·∣m⊗) ■ ~·· (·~ ⊗⊗ ■ - ·⊗· ■ ~⊗ /-n·⊗∣)
                     ■ ~· (·⊗· ■ ~· -⊗⊗) ■ -·· ■ ·~ (- (/-n+ {n} {l}))
/-n·⊗∣ {d = ∩}     = - (·· ■ ·~ (⊗~ (·∣∣ ■ ⊗ε)) ■ ~· (·~ (⊗~ ⊗ε)) ■ ∣∩/∣∣/ ■ - ∣·)
/-n·⊗∣ {d = ∪}     = ~· (~· (⊗~ ⊗ε) ■ ·~ (⊗~ (·∣∣ ■ ⊗ε))) ■ /∣∣/∪∣ ■ - ·∣
/-n·⊗∣ {d = /}     = ~· (~· (⊗~ ⊗ε) ■ ·~ (⊗~ (·∣∣ ■ ⊗ε))) ■ ///
                     ■ - (·~ (~· (⊗~ ⊗ε) ■ ·~ (⊗~ (·∣∣ ■ ⊗ε))) ■ ··)
/-n·⊗∣ {d = R}     = /-nR
/-n·⊗∣ {d = M}     = ·~ /-M ■ ∣· ■ ·~ (- ⊗ε ■ - ·∣∣)
/-n·⊗∣ {d = B ns}  = /-nB

/mn·∣⊗ : ∀{m n k}{d : D m n} → /mn m k · ∣ ^⊗ k ⊗ d ~ d ⊗ ∣ ^⊗ k · /mn n k
/mn·∣⊗ {k = zero}  = ∣n· ■ ε⊗ ■ - ⊗ε ■ - ·∣n
/mn·∣⊗ {k = suc k} = ··~ (·~ -⊗⊗ ■ ∣⊗·∣⊗ ■ ⊗~ (/mn·∣⊗ {k = k}) ■ - ∣⊗·∣⊗)
                     ■ ~·· (·~ ⊗⊗ ■ - ·⊗· ■ ~⊗ /n·∣⊗ ■ ·⊗· ■ ~· -⊗⊗) ■ -··

/0n : ∀{n} → /mn 0 n ~ ∣ ^⊗ n
/0n {zero}  = rfl
/0n {suc n} = ∣⊗·∣⊗ ■ ⊗~ (∣n· ■ /0n)

/1n : ∀{n} → /mn 1 n ~ /-n
/1n {zero}  = ⊗ε
/1n {suc n} = ·~ (⊗~ /1n) ■ ~· (~⊗ (·∣∣ ■ ε⊗))

/n1 : ∀{n} → /mn n 1 ~ /n
/n1 {n} = ·∣n ■ ⊗ε

/sucmn : ∀{m n} → /mn (suc m) n ~ ∣ ^⊗ m ⊗ /-n {n} · /mn m n ⊗ ∣
/sucmn {n = zero}  = ∣^⊗suc ■ ~⊗ (- ∣n·) ■ - ⊗∣·⊗∣
/sucmn {n = suc n} = ·~ (⊗~ (/sucmn {n = n}))
                     ■ ·~ (- ∣⊗·∣⊗) ■ ~· (- ⊗∣n·⊗∣n)
                     ■ ~·· (-·· ■ ~· -⊗⊗ ■ ·~ (·~ ⊗⊗ ■ ~· -⊗⊗ ■ ⊗∣n·∣m⊗
                      ■ - (~· (⊗⊗ ■ ~⊗ (- ∣^⊗suc)) ■ ·~ (-⊗⊗ ■ ⊗~ (- ∣^⊗suc)) ■ ∣n⊗·⊗∣m)) ■ ··)
                     ■ ·~ ⊗⊗ ■ -·· ■ ~· ∣n⊗·∣n⊗ ■ ·~ ⊗∣·⊗∣

/mn·⊗∣ : ∀{m n k}{d : D m n} → /mn k m · d ⊗ ∣ ^⊗ k ~ ∣ ^⊗ k ⊗ d · /mn k n
/mn·⊗∣ {k = zero} = ~· /0n ■ ∣n· ■ ⊗ε ■ - ε⊗ ■ - ·∣n ■ ·~ (- /0n)
/mn·⊗∣ {m}{n}{suc k}{d} = ~· (/sucmn {k})
                          ■ ··~ (·~ (⊗~ ∣^⊗suc ■ ⊗⊗) ■ ⊗∣·⊗∣ ■ ~⊗ (/mn·⊗∣ {m} {n} {k}) ■ - ⊗∣·⊗∣)
                          ■ (~·· (·~ -⊗⊗ ■ ∣n⊗·∣n⊗ ■ ⊗~ /-n·⊗∣ ■ - ∣n⊗·∣n⊗ ■ ~· (⊗⊗ ■ ~⊗ (- ∣^⊗suc))) ■ -··)
                          ■ ·~ (- (/sucmn {k}))

-- Naturality of /mn
/mn·⊗ : ∀{m n k l}{d : D m n}{e : D k l}
  → /mn k m · d ⊗ e ~ e ⊗ d · /mn l n
/mn·⊗ = ·~ (- ∣n⊗·⊗∣m) ■ ~·· /mn·∣⊗ ■ ··~ /mn·⊗∣ ■ ~·· ⊗∣n·∣m⊗
